<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <style>
    .task-priority-high { border-left: 4px solid #e53e3e; }
    .task-priority-medium { border-left: 4px solid #dd6b20; }
    .task-priority-low { border-left: 4px solid #38a169; }

    .task-status-todo { background-color: #ebf8ff; color: #3182ce; }
    .task-status-inprogress { background-color: #fff5eb; color: #dd6b20; }
    .task-status-review { background-color: #faf5ff; color: #805ad5; }
    .task-status-completed { background-color: #f0fff4; color: #38a169; }

    .completed-task {
      opacity: 0.8;
      background-color: #f9fafb;
      position: relative;
      cursor: pointer;
    }
    .completed-task h3 { text-decoration: line-through; color: #9ca3af !important; }
    .completed-task p { color: #9ca3af !important; }

    .revert-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.75rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      z-index: 10;
    }

    .completed-task:hover .revert-btn {
      opacity: 1;
    }
     .detail-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 5px;
            display: block;
        }

        .detail-value {
            color: #1f2937;
        }

        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .detail-tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

    .revert-btn:hover {
      background-color: #2563eb;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .skip-btn {
            background-color: transparent;
            color: #6b7280;
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .skip-btn:hover {
            background-color: #f9fafb;
            color: #4b5563;
            border-color: #9ca3af;
        }

        .skip-confirm-modal .task-details-content {
            max-width: 500px;
        }

        .skip-reason-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-top: 10px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .skip-reason-input:focus {
            outline: none;
            border-color: #780aff;
            box-shadow: 0 0 0 3px rgba(120, 10, 255, 0.2);
        }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-secondary {
      background-color: #6b7280;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div layout:fragment="content">

  <!-- Page Title -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
    <h1 class="text-2xl md:text-3xl font-bold text-blue-800 mb-4 md:mb-0">
      <i class="fas fa-tasks mr-3 text-blue-600"></i>
      Task Management
    </h1>
  </div>

  <!-- Current Task Section -->
  <div class="mb-8" th:if="${#lists.isEmpty(tasks) == false}">
    <h2 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
      <i class="fas fa-star mr-2 text-yellow-500"></i>
      Current Task
    </h2>

    <!-- Show only tasks with state CREATED -->
    <div th:each="task : ${tasks}" th:if="${task.state == 'created'}"
         class="bg-white border border-gray-200 rounded-xl p-5 card-hover shadow-sm"
    >

      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
        <div>
          <h3 class="font-bold text-blue-700 text-lg md:text-xl mb-1"
              th:text="${task.name}">Task Name</h3>
          <div class="flex items-center flex-wrap gap-2">
            <span class="text-xs px-2 py-1 task-status-inprogress rounded-full"
            >In Progress</span>
          </div>
        </div>

        <div class="flex items-center mt-3 md:mt-0">
          <span class="text-sm text-gray-600"
                th:text="${'Created Date: ' + task.createTime}">Due:</span>
        </div>
      </div>

      <p class="text-gray-600 text-sm mb-4"
      >This is the task currently in progress. It requires immediate attention and active work to move the project forward. Review the details and complete the pending steps to ensure the task is finished on time</p>
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center">
          <div class="mr-4">
            <span class="text-xs text-gray-500 block">Progress:</span>
            <span class="text-xs text-gray-500"
            >Not Started</span>
          </div>
        </div>

        <div class="flex space-x-2">
          <a th:href="@{/tasks/view/{taskId}(taskId=${task.id})}" class="gradient-bg text-white px-4 py-2 rounded-lg text-sm flex items-center">
            <i class="fas fa-hand-paper mr-1"></i> Claim Task
          </a>
          <a
                  th:hx-get="@{/tasks/skip-confirm/{taskId}(taskId=${task.id})}"
                  hx-target="#skip-task-modal-container"
                  hx-swap="innerHTML"
                  class="skip-btn" >
            <i class="fas fa-forward mr-1"></i> Skip Task
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Completed Tasks Section -->
  <div th:if="${!#lists.isEmpty(completedTasks)}">
    <h2 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
      <i class="fas fa-check-circle mr-2 text-green-600"></i>
      Completed Tasks
    </h2>

    <div class="grid grid-cols-1 gap-4">
      <div th:each="task : ${completedTasks}"
           class="completed-task border border-gray-200 rounded-xl p-4 card-hover shadow-sm">

        <!-- Revert Button -->
        <button class="revert-btn"
                th:hx-get="@{/tasks/revert-confirm/{taskId}(taskId=${task.id})}"
                hx-target="#modal-container"
                hx-swap="innerHTML">
          <i class="fas fa-undo-alt"></i> Revert
        </button>

        <!-- Task Content -->
        <a th:href="@{/tasks/viewCompleted/{taskId}(taskId=${task.id})}" class="block">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
            <div>
              <h3 class="font-bold text-base md:text-lg mb-1"
                  th:text="${task.name}">Completed Task</h3>
              <div class="flex items-center flex-wrap gap-2">
                <span class="text-xs px-2 py-1 task-status-completed rounded-full">Completed</span>
              </div>
            </div>
            <div class="flex items-center mt-2 md:mt-0">
              <span class="text-sm text-gray-400">Completed: --</span>
            </div>
          </div>

          <p class="text-gray-600 text-sm mb-4">
            This task has been successfully completed. All requirements were met, and the deliverables are finalized.
            No further action is required.
          </p>

          <div class="flex justify-between items-center">
            <div class="flex items-center">
              <i class="fas fa-code-branch text-gray-400"></i>
            </div>
            <div class="text-xs text-gray-400" th:text="${'Created Date: ' + task.createTime}">Created: --</div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container"></div>

<!--  Skip Task Modal Container-->
    <div id="skip-task-modal-container"></div>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Animate progress bars
      const bars = document.querySelectorAll('.progress-transition');
      bars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0';
        setTimeout(() => bar.style.width = width, 500);
      });

      // Close modal when clicking outside
      document.addEventListener('click', function(e) {
        if (e.target.id === 'modal-overlay') {
          document.getElementById('modal-container').innerHTML = '';
        }
      });
      // Close skip modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'skip-modal-overlay') {
            document.getElementById('skip-task-modal-container').innerHTML = '';
            }
        });
    });
  </script>
</div>
</body>
</html>