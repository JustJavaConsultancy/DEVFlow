<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevFlow - Project Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Rich Text Editor Styles */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid #e2e8f0;
        }
        .toolbar-group:last-child { border-right: none; }
        .toolbar-btn {
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s ease;
        }
        .toolbar-btn:hover {
            background: #edf2f7;
            color: #780aff;
        }
        .toolbar-btn.active {
            background: #e9d5ff;
            color: #780aff;
        }
        .editor-content {
            min-height: 400px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            outline: none;
            background: white;
        }
        .editor-content:focus {
            border-color: #780aff;
            box-shadow: 0 0 0 3px rgba(120, 10, 255, 0.1);
        }
        .editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        .character-counter {
            text-align: right;
            font-size: 0.875rem;
            color: #718096;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Title -->
    <div class="mb-8 mt-6">
        <h1 class="text-2xl md:text-3xl font-bold text-blue-800">
            <i class="fas fa-file-alt mr-3 text-blue-600"></i>
            Requirements
        </h1>
        <p class="text-gray-600 mt-2">Create detailed requirements for your project</p>
    </div>

    <!-- ✅ Requirements Form -->
    <form th:action="@{/tasks/complete/{taskId}(taskId=${taskId})}" method="post"
          id="requirementForm"
          class="bg-white border border-gray-200 rounded-lg p-4 md:p-5 mb-6">
    <div class="mb-4">
            <label class="block text-gray-700 text-sm font-medium mb-2">
                Requirement Description
            </label>

            <!-- Toolbar -->
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                    <button type="button" class="toolbar-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                    <button type="button" class="toolbar-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="justifyLeft"><i class="fas fa-align-left"></i></button>
                    <button type="button" class="toolbar-btn" data-command="justifyCenter"><i class="fas fa-align-center"></i></button>
                    <button type="button" class="toolbar-btn" data-command="justifyRight"><i class="fas fa-align-right"></i></button>
                    <button type="button" class="toolbar-btn" data-command="justifyFull"><i class="fas fa-align-justify"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                    <button type="button" class="toolbar-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                    <button type="button" class="toolbar-btn" data-command="outdent"><i class="fas fa-outdent"></i></button>
                    <button type="button" class="toolbar-btn" data-command="indent"><i class="fas fa-indent"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="createLink"><i class="fas fa-link"></i></button>
                    <button type="button" class="toolbar-btn" data-command="insertImage"><i class="fas fa-image"></i></button>
                    <button type="button" class="toolbar-btn" data-command="insertTable"><i class="fas fa-table"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="code"><i class="fas fa-code"></i></button>
                    <button type="button" class="toolbar-btn" data-command="quote"><i class="fas fa-quote-right"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="undo"><i class="fas fa-undo"></i></button>
                    <button type="button" class="toolbar-btn" data-command="redo"><i class="fas fa-redo"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="removeFormat"><i class="fas fa-eraser"></i></button>
                    <button type="button" class="toolbar-btn" data-command="hiliteColor" data-value="#fffd80"><i class="fas fa-highlighter"></i></button>
                </div>
            </div>

            <!-- Editable area -->
            <div class="editor-content" id="requirementEditor" contenteditable="true">
                <p>Describe your requirements in detail...</p>
            </div>

            <!-- ✅ Hidden field -->
            <input type="hidden" name="requirement" id="requirementText"/>

            <div class="character-counter">
                <span id="charCount">0</span> characters
            </div>
        </div>

        <div th:if="${!isCompleted}" class="editor-actions">
            <button type="submit" id="submitBtn"
                    class="gradient-bg text-white px-4 py-2 rounded-md flex items-center action-btn">
                <i class="fas fa-paper-plane mr-2"></i>
                Submit Requirement
            </button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const editor = document.getElementById('requirementEditor');
            const hiddenInput = document.getElementById('requirementText');
            const form = document.getElementById('requirementForm');
            const submitBtn = document.getElementById('submitBtn');
            const charCount = document.getElementById('charCount');
            const toolbarButtons = document.querySelectorAll('.toolbar-btn');

            // Update character count
            function updateCharCount() {
                charCount.textContent = (editor.innerText || '').length;
            }
            editor.addEventListener('input', updateCharCount);
            updateCharCount();

            // Toolbar functionality
            toolbarButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    const value = button.dataset.value || null;

                    if (command === 'code') {
                        document.execCommand('formatBlock', false, 'pre');
                    } else if (command === 'quote') {
                        document.execCommand('formatBlock', false, 'blockquote');
                    } else if (command === 'insertTable') {
                        const rows = prompt('Rows:', '3');
                        const cols = prompt('Cols:', '3');
                        if (rows && cols) {
                            let tableHTML = '<table border="1" style="width:100%; border-collapse:collapse; margin:10px 0;"><tbody>';
                            for (let i = 0; i < rows; i++) {
                                tableHTML += '<tr>';
                                for (let j = 0; j < cols; j++) {
                                    tableHTML += '<td style="padding:8px;">&nbsp;</td>';
                                }
                                tableHTML += '</tr>';
                            }
                            tableHTML += '</tbody></table>';
                            document.execCommand('insertHTML', false, tableHTML);
                        }
                    } else if (command === 'createLink') {
                        const url = prompt('Enter URL:', 'https://');
                        if (url) document.execCommand('createLink', false, url);
                    } else if (command === 'insertImage') {
                        const url = prompt('Enter image URL:', 'https://');
                        if (url) document.execCommand('insertImage', false, url);
                    } else if (command === 'hiliteColor') {
                        document.execCommand('hiliteColor', false, value);
                    } else {
                        document.execCommand(command, false, value);
                    }

                    editor.focus();
                });
            });

            // ✅ On form submit: transfer HTML & disable button
            form.addEventListener('submit', function () {
                hiddenInput.value = editor.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
            });
        });
    </script>
</div>
</body>
</html>
