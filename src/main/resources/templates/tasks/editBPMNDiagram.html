<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <title>DevFlow - Project Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js library for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        /* Rich Text Editor Styles */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid #e2e8f0;
        }
        .toolbar-group:last-child { border-right: none; }
        .toolbar-btn {
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s ease;
        }
        .toolbar-btn:hover {
            background: #edf2f7;
            color: #780aff;
        }
        .toolbar-btn.active {
            background: #e9d5ff;
            color: #780aff;
        }
        .editor-content {
            min-height: 400px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            outline: none;
            background: white;
            white-space: pre-wrap;
        }
        .editor-content:focus {
            border-color: #780aff;
            box-shadow: 0 0 0 3px rgba(120, 10, 255, 0.1);
        }
        .editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        .character-counter {
            text-align: right;
            font-size: 0.875rem;
            color: #718096;
            margin-top: 0.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: #780aff;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: #6a00e6;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
        }
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        .error-message {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #4a5568;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(120, 10, 255, 0.3);
            border-radius: 50%;
            border-top-color: #780aff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Placeholder text styling */
        .editor-content[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #a0aec0;
            font-style: italic;
        }

        /* Upload button highlight */
        .highlight-upload {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Cursor instruction styles */
        .cursor-instruction {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .cursor-instruction i {
            color: #780aff;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Title -->
    <div class="mb-8 mt-6">
        <h1 class="text-2xl md:text-3xl font-bold text-blue-800">
            <i class="fas fa-code mr-3 text-blue-600"></i>
            Edit BPMN Diagram
        </h1>
        <p class="text-gray-600 mt-2" th:text="${processVariables.projectName}">
            E-Commerce Platform Project - Checkout Service
        </p>
    </div>

    <!-- Edit BPMN Diagram -->
    <form th:action="@{/tasks/complete/{taskId}(taskId=${taskId})}" method="post"
          id="editBPMNForm"
          class="bg-white border border-gray-200 rounded-lg p-4 md:p-5 mb-6">

        <!-- CSRF Token -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!--  BPMN Diagram Text Layout-->
        <div class="mb-4">
            <div class="flex w-full justify-between items-center">
            <label class="block text-gray-700 text-sm font-medium mb-2">
                BPMN Diagram Text
            </label>
            <button type="button" id="downloadBtn"
                    class="gradient-bg text-white px-4 py-2 rounded-md flex items-center action-btn">
                <i class="fas fa-download mr-2"></i>
                Download BPMN
            </button>
            </div>
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                    <button type="button" class="toolbar-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                    <button type="button" class="toolbar-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="justifyLeft"><i class="fas fa-align-left"></i></button>
                    <button type="button" class="toolbar-btn" data-command="justifyCenter"><i class="fas fa-align-center"></i></button>
                    <button type="button" class="toolbar-btn" data-command="justifyRight"><i class="fas fa-align-right"></i></button>
                    <button type="button" class="toolbar-btn" data-command="justifyFull"><i class="fas fa-align-justify"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                    <button type="button" class="toolbar-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                    <button type="button" class="toolbar-btn" data-command="outdent"><i class="fas fa-outdent"></i></button>
                    <button type="button" class="toolbar-btn" data-command="indent"><i class="fas fa-indent"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="createLink"><i class="fas fa-link"></i></button>
                    <button type="button" class="toolbar-btn" data-command="insertImage"><i class="fas fa-image"></i></button>
                    <button type="button" class="toolbar-btn" data-command="insertTable"><i class="fas fa-table"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="code"><i class="fas fa-code"></i></button>
                    <button type="button" class="toolbar-btn" data-command="quote"><i class="fas fa-quote-right"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="undo"><i class="fas fa-undo"></i></button>
                    <button type="button" class="toolbar-btn" data-command="redo"><i class="fas fa-redo"></i></button>
                </div>
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-command="removeFormat"><i class="fas fa-eraser"></i></button>
                    <button type="button" class="toolbar-btn" data-command="hiliteColor" data-value="#fffd80"><i class="fas fa-highlighter"></i></button>
                </div>
            </div>

            <!-- Editable area with placeholder -->
            <div class="editor-content" id="requirementEditor" contenteditable="true"
                 th:text="${processVariables.bpmnDefinition}"
                 data-placeholder="Kindly, paste your bpmn definition..."></div>

<!--             ✅ Hidden field-->
            <input type="hidden" name="bpmnDefinition" id="bpmnDefinitionInput"/>

            <div class="character-counter">
                <span id="charCount">0</span> characters
            </div>
        </div>

        <div class="editor-actions">
            <button type="submit" id="submitBtn"
                    class="gradient-bg text-white px-4 py-2 rounded-md flex items-center action-btn">
                <i class="fas fa-paper-plane mr-2"></i>
                Submit Diagram
            </button>
        </div>
    </form>
    <script>
        function formatXml(xml) {
            const PADDING = ' '.repeat(2); // indent size
            const reg = /(>)(<)(\/*)/g;
            let pad = 0;
            xml = xml.replace(reg, '$1\r\n$2$3'); // add line breaks

            return xml.split('\r\n').map(line => {
                let indent = 0;
                if (line.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (line.match(/^<\/\w/)) {
                    if (pad > 0) pad -= 1;
                } else if (line.match(/^<\w([^>]*[^/])?>.*$/)) {
                    indent = 1;
                }

                const paddedLine = PADDING.repeat(pad) + line;
                pad += indent;
                return paddedLine;
            }).join('\n');
    }

        document.addEventListener('DOMContentLoaded', function () {
              const downloadBtn = document.getElementById('downloadBtn');
              const editor = document.getElementById('requirementEditor');
              const hiddenInput = document.getElementById('bpmnDefinitionInput');
              const submitBtn = document.getElementById('submitBtn');
              const form = document.getElementById('editBPMNForm');
              const charCount = document.getElementById('charCount');
              const toolbarButtons = document.querySelectorAll('.toolbar-btn');

              console.log(editor.textContent.length);
              if (editor && editor.textContent.trim()) {
                const formatted = formatXml(editor.textContent.trim());
                editor.textContent = formatted;
            }

              // Update character count
              function updateCharCount() {
                  // Don't count placeholder text
                  const text = editor.textContent;
                  const placeholderText = editor.getAttribute('data-placeholder');
                  const actualText = text === placeholderText ? '' : text;
                  charCount.textContent = actualText.length;
              }

              // Handle placeholder behavior
              function handlePlaceholder() {
                  if (!editor.textContent.trim()) {
                      editor.textContent = editor.getAttribute('data-placeholder');
                      editor.classList.add('placeholder');
                  }
              }

              function clearPlaceholder() {
                  if (editor.classList.contains('placeholder')) {
                      editor.textContent = '';
                      editor.classList.remove('placeholder');
                  }
              }

              // Initialize placeholder
              handlePlaceholder();
              updateCharCount();

<!--              editor.addEventListener('focus', clearPlaceholder);-->
              editor.addEventListener('blur', handlePlaceholder);
              editor.addEventListener('input', updateCharCount);

              // Toolbar functionality
              toolbarButtons.forEach(button => {
                  button.addEventListener('click', () => {
                      clearPlaceholder();
                      const command = button.dataset.command;
                      const value = button.dataset.value || null;

                      if (command === 'code') {
                          document.execCommand('formatBlock', false, 'pre');
                      } else if (command === 'quote') {
                          document.execCommand('formatBlock', false, 'blockquote');
                      } else if (command === 'insertTable') {
                          const rows = prompt('Rows:', '3');
                          const cols = prompt('Cols:', '3');
                          if (rows && cols) {
                              let tableHTML = '<table border="1" style="width:100%; border-collapse:collapse; margin:10px 0;"><tbody>';
                              for (let i = 0; i < rows; i++) {
                                  tableHTML += '<tr>';
                                  for (let j = 0; j < cols; j++) {
                                      tableHTML += '<td style="padding:8px;">&nbsp;</td>';
                                  }
                                  tableHTML += '</tr>';
                              }
                              tableHTML += '</tbody></table>';
                              document.execCommand('insertHTML', false, tableHTML);
                          }
                      } else if (command === 'createLink') {
                          const url = prompt('Enter URL:', 'https://');
                          if (url) document.execCommand('createLink', false, url);
                      } else if (command === 'insertImage') {
                          const url = prompt('Enter image URL:', 'https://');
                          if (url) document.execCommand('insertImage', false, url);
                      } else if (command === 'hiliteColor') {
                          document.execCommand('hiliteColor', false, value);
                      } else {
                          document.execCommand(command, false, value);
                      }

                      editor.focus();
                      updateCharCount();
                  });
              });

            // download editor content
            downloadBtn.addEventListener('click', function () {
                const content = editor.textContent.trim();

                if(!content){
                    alert('Editor is empty');
                    return;
                }

                //create a blob with xml mime type
                const blob = new Blob([content], {type: 'application/xml'});

                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'bpmn-definition.xml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            });

            // ✅ On form submit: transfer HTML & disable button
            form.addEventListener('submit', function () {
                hiddenInput.value = editor.textContent.trim();
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
            });

    });
    </script>
</div>
</body>
</html>