<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review User Stories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Provide CSRF tokens when Spring Security is active -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .btn-disabled { opacity: 0.7; cursor: not-allowed; } .btn-disabled:hover { transform: none; box-shadow: none; } .gradient-bg { background: linear-gradient(135deg, #780aff 0%, #4b7bec 100%); }
        /* Custom styles for user story cards */
        .user-story-card {
            transition: all 0.3s ease;
            border-left: 4px solid #780aff;
        }

        .user-story-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(120, 10, 255, 0.15);
        }

        .priority-high {
            border-left-color: #e53e3e;
        }

        .priority-medium {
            border-left-color: #ed8936;
        }

        .priority-low {
            border-left-color: #38a169;
        }

        .action-btn {
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Edit mode styles */
        .edit-mode {
            box-shadow: 0 0 0 2px #780aff;
            background-color: #f9f9ff;
        }

        .save-btn {
            background-color: #10b981;
            color: white;
        }

        .save-btn:hover {
            background-color: #059669;
        }

        .cancel-btn {
            background-color: #6b7280;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #4b5563;
        }

        .editable-content {
            transition: all 0.2s ease;
        }

        .editable-content:focus {
            background-color: #f0f8ff;
            outline: 2px solid #780aff;
            border-radius: 4px;
            padding: 4px;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(120, 10, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(120, 10, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(120, 10, 255, 0); }
        }

        /* HTMX loading states */
        .htmx-request {
            opacity: 0.7;
            cursor: wait;
        }

        .htmx-indicator {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .htmx-request .htmx-indicator {
            opacity: 1;
        }

        /* Enhanced styles for editable criteria */
        [data-field="criteria"] li[contenteditable="true"] {
            background-color: #f0f8ff;
            border-radius: 4px;
            outline: 1px solid #780aff;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            padding: 2px 4px;
        }

        [data-field="criteria"] li[contenteditable="true"]:focus {
            background-color: #e6f3ff;
            outline: 2px solid #780aff;
        }

        /* Make the entire criteria list more editable-friendly */
        [data-field="criteria"][contenteditable="true"] {
            min-height: 60px;
            padding: 8px;
            background-color: #f9f9ff;
            border-radius: 6px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">

    <!-- Page Title -->
    <div class="mb-8 mt-6">
        <h1 class="text-2xl md:text-3xl font-bold text-blue-800">
            <i class="fas fa-list-alt mr-3 text-blue-600"></i>
            Review User Stories
        </h1>
        <p th:text="${processVariables.projectName}" class="text-gray-600 mt-2">E-Commerce Platform Project - v2.3</p>
    </div>

    <!-- Stats Card -->
    <div class="gradient-bg rounded-xl p-4 md:p-6 text-white mb-8 flex items-center justify-between">
        <div>
            <i class="fas fa-list-ol text-2xl md:text-3xl mb-2 text-blue-200"></i>
            <h3 th:text="${processVariables.stories.total}" class="text-xl md:text-2xl font-bold mb-1">15</h3>
            <p class="text-blue-200 text-sm md:text-base">Total User Stories</p>
        </div>
        <!-- Download Button -->
        <button id="downloadPdfBtn"
                class="bg-white text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg flex items-center action-btn transition-all duration-300 font-medium">
            <i class="fas fa-download mr-2"></i>
            Export Stories
        </button>
    </div>

    <form id="userStoriesForm" th:action="@{/tasks/complete/{taskId}(taskId=${taskId})}" method="post">
        <!-- CSRF Token for main form -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- User Stories Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
            <!-- User Story Card -->
            <div th:each="story, iterStat : *{processVariables.stories.user_stories}"
                 class="user-story-card priority-high bg-white border border-gray-200 rounded-lg p-4 md:p-5"
                 th:attr="data-story-id=${story.id}">
                <div class="flex justify-between items-start mb-3">
                    <span th:switch="${story.priority}">
    <span th:case="'Must have'" class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">High Priority</span>
    <span th:case="'Should have'" class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Medium Priority</span>
    <span th:case="'Could have'" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Low Priority</span>
    <span th:case="'Won’t have'" class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Not Planned</span>
    <span th:case="*" class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Not Planned</span>
</span>
                    <span th:text="${story.id}" class="text-xs text-gray-500">US-101</span>
                </div>

                <p th:text="${story.story}" class="text-gray-600 text-sm mb-4 editable-content" data-field="story">As a new visitor, I want to create an account so that I can make purchases and save my preferences.</p>

                <div class="mb-4">
                    <h4 class="font-medium text-sm text-blue-700 mb-1">Acceptance Criteria:</h4>
                    <ul class="text-xs text-gray-600 list-disc pl-5 space-y-1 editable-content" data-field="criteria">
                        <li th:each="criteria : ${story.acceptance_criteria}" th:text="${criteria}"></li>
                    </ul>
                </div>

                <!-- Edit/Save/Cancel buttons -->
                <div class="flex justify-end space-x-2">
                    <button type="button" class="text-blue-600 hover:text-blue-800 action-btn edit-btn">
                        <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                    <button type="button"
                            class="save-btn px-3 py-1 rounded text-sm hidden"
                            data-story-id="${story.id}">
                        <i class="fas fa-check mr-1"></i>
                        <span>Save</span>
                        <i class="fas fa-spinner fa-spin htmx-indicator ml-1"></i>
                    </button>
                    <button type="button" class="cancel-btn px-3 py-1 rounded text-sm hidden">
                        <i class="fas fa-times mr-1"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Save All Button -->
        <div th:if="${!isCompleted}" class="flex justify-center mt-6">
            <button id="submitBtn" class="gradient-bg text-white px-6 py-3 rounded-lg flex items-center action-btn">
                <i class="fas fa-save mr-2"></i>
                Save All User Stories
            </button>
        </div>
    </form>

    <!-- Hidden logo element for PDF generation -->
    <img id="pdfLogo" src="/images/JJ LOGOMARK COLORED.png" style="display: none;" alt="Logo" />

    <script>
        // Configure HTMX with CSRF token
        document.addEventListener('DOMContentLoaded', function() {
           /*********************************
     * CSRF integration and autosave
     *********************************/
    (function setupHtmxCsrf() {
      const metaToken = document.querySelector('meta[name="_csrf"]');
      const metaHeader = document.querySelector('meta[name="_csrf_header"]');
      if (metaToken && metaHeader && window.htmx) {
        const csrfToken = metaToken.getAttribute('content');
        const csrfHeader = metaHeader.getAttribute('content');
        // Add the CSRF header to every htmx request:
        document.addEventListener('htmx:configRequest', function (evt) {
          evt.detail.headers[csrfHeader] = csrfToken;
        });
      }
    })();

        });

        const submitBtn = document.getElementById('submitBtn');
        const userStoriesForm = document.getElementById('userStoriesForm');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');

        // Edit functionality
        let originalContents = new Map();

        // Initialize edit buttons
        document.addEventListener('DOMContentLoaded', function() {
            const editButtons = document.querySelectorAll('.edit-btn');

            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const card = this.closest('.user-story-card');
                    const storyId = card.querySelector('span.text-xs.text-gray-500:last-child').textContent;

                    // If already in edit mode, do nothing
                    if (card.classList.contains('edit-mode')) {
                        return;
                    }

                    // Store original content
                    originalContents.set(storyId, {
                        story: card.querySelector('[data-field="story"]').innerHTML,
                        criteria: card.querySelector('[data-field="criteria"]').innerHTML
                    });

                    // Enter edit mode
                    enterEditMode(card, storyId);
                });
            });

            // Save All button functionality
            if (submitBtn) {
                submitBtn.addEventListener('click', function() {
                    const editedCards = document.querySelectorAll('.user-story-card.edit-mode');

                    if (editedCards.length > 0) {
                        // Save all edited cards using HTMX
                        const savePromises = Array.from(editedCards).map(card => {
                            return saveCardWithHtmx(card);
                        });

                        Promise.all(savePromises).then(() => {
                            showNotification('All user stories saved successfully!', 'success');
                        }).catch(error => {
                            showNotification('Error saving some stories', 'error');
                        });
                    } else {
                        showNotification('No changes to save.', 'info');
                    }
                });
            }
        });

        function enterEditMode(card, storyId) {
            // Add edit mode styling
            card.classList.add('edit-mode', 'pulse');

            // Show save and cancel buttons, hide edit button
            const editBtn = card.querySelector('.edit-btn');
            const saveBtn = card.querySelector('.save-btn');
            const cancelBtn = card.querySelector('.cancel-btn');

            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');

            // Make content editable
            const editableElements = card.querySelectorAll('.editable-content');
            editableElements.forEach(element => {
                element.setAttribute('contenteditable', 'true');
                element.classList.add('editable-content');
            });

            // Make criteria list items editable individually
            const criteriaItems = card.querySelectorAll('[data-field="criteria"] li');
            criteriaItems.forEach(item => {
                item.setAttribute('contenteditable', 'true');
                item.classList.add('editable-content');
                item.style.cursor = 'text';
                item.style.padding = '2px 4px';
                item.style.marginBottom = '2px';
            });

            // Add event listeners for save and cancel
            saveBtn.onclick = () => saveCardWithHtmx(card);
            cancelBtn.onclick = () => cancelEdit(card, storyId);

            // Focus on the story text for better UX
            const storyElement = card.querySelector('[data-field="story"]');
            storyElement.focus();

            // Remove pulse animation after a while
            setTimeout(() => {
                card.classList.remove('pulse');
            }, 2000);
        }

        function addNewCriteria(card) {
            const criteriaList = card.querySelector('[data-field="criteria"]');
            const newItem = document.createElement('li');
            newItem.setAttribute('contenteditable', 'true');
            newItem.classList.add('editable-content');
            newItem.style.cursor = 'text';
            newItem.style.padding = '2px 4px';
            newItem.style.marginBottom = '2px';
            newItem.textContent = 'New acceptance criteria...';
            criteriaList.appendChild(newItem);

            // Focus on the new item
            newItem.focus();
        }

        function saveCardWithHtmx(card) {
            const storyId = card.querySelector('span.text-xs.text-gray-500:last-child').textContent;
            const storyText = card.querySelector('[data-field="story"]').textContent;

            // Get acceptance criteria as text with line breaks
            const criteriaElements = card.querySelectorAll('[data-field="criteria"] li');
            let acceptanceCriteria = '';
            criteriaElements.forEach(li => {
                if (li.textContent.trim() !== '') {
                    acceptanceCriteria += li.textContent + '\n';
                }
            });

            const saveBtn = card.querySelector('.save-btn');

            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            // Show loading state
            saveBtn.disabled = true;
            saveBtn.querySelector('span').textContent = 'Saving...';

            // Use fetch API instead of htmx.ajax for better error handling
            fetch('/api/stories/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                },
                body: new URLSearchParams({
                    storyId: storyId,
                    story: storyText,
                    acceptanceCriteria: acceptanceCriteria,
                    taskId: '[[${taskId}]]',
                    _csrf: csrfToken
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    exitEditMode(card);
                    showNotification(`Saved changes to ${storyId}`, 'success');
                    return response.text();
                } else {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
            })
            .then(responseText => {
                console.log('Response text:', responseText);
            })
            .catch(error => {
                console.error('Error saving story:', error);
                showNotification(`Error saving ${storyId}: ${error.message}`, 'error');
                saveBtn.disabled = false;
                saveBtn.querySelector('span').textContent = 'Save';
            });
        }

        function exitEditMode(card) {
            const storyId = card.querySelector('span.text-xs.text-gray-500:last-child').textContent;

            // Remove edit mode styling
            card.classList.remove('edit-mode');

            // Show edit button, hide save and cancel buttons
            const editBtn = card.querySelector('.edit-btn');
            const saveBtn = card.querySelector('.save-btn');
            const cancelBtn = card.querySelector('.cancel-btn');

            editBtn.classList.remove('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');

            // Reset save button state
            saveBtn.disabled = false;
            saveBtn.querySelector('span').textContent = 'Save';

            // Make content non-editable
            const editableElements = card.querySelectorAll('.editable-content');
            editableElements.forEach(element => {
                element.setAttribute('contenteditable', 'false');
            });

            // Make criteria items non-editable
            const criteriaItems = card.querySelectorAll('[data-field="criteria"] li');
            criteriaItems.forEach(item => {
                item.setAttribute('contenteditable', 'false');
                item.style.cursor = 'default';
                item.style.padding = '0';
                item.style.marginBottom = '0';
            });

            // Remove from original contents if it exists
            if (originalContents.has(storyId)) {
                originalContents.delete(storyId);
            }
        }

        function cancelEdit(card, storyId) {
            // Restore original content
            if (originalContents.has(storyId)) {
                const original = originalContents.get(storyId);
                card.querySelector('[data-field="story"]').innerHTML = original.story;
                card.querySelector('[data-field="criteria"]').innerHTML = original.criteria;

                originalContents.delete(storyId);
            }

            exitEditMode(card);
            showNotification(`Edit cancelled for ${storyId}`, 'info');
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' :
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in ${bgColor} text-white`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${icon} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            // Add to page
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('fade-in');
                notification.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Form submission handler
        userStoriesForm.addEventListener('submit', function(e) {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-disabled');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
        });

        // PDF Download functionality (unchanged)
        downloadPdfBtn.addEventListener('click', function() {
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating PDF...';

            generatePDF().finally(() => {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = '<i class="fas fa-download mr-2"></i> Export Stories';
            });
        });

        // generatePDF function remains the same as in your original code
        async function generatePDF() {
           try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Get data from the page
                const storyCards = document.querySelectorAll('.user-story-card');
                const projectName = document.querySelector('p.text-gray-600').textContent;
                const totalStories = document.querySelector('.gradient-bg h3').textContent;

                // PDF settings
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                let yPosition = margin;

                // Function to add text with line breaks
                const addWrappedText = (text, x, y, maxWidth, lineHeight = 7) => {
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    pdf.text(lines, x, y);
                    return lines.length * lineHeight;
                };

                // Function to check if we need a new page
                const checkPageBreak = (requiredHeight) => {
                    if (yPosition + requiredHeight > pdf.internal.pageSize.getHeight() - margin) {
                        pdf.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                };

                // Function to create a better looking priority badge
                const drawPriorityBadge = (x, y, text, priorityType) => {
                    // Define colors based on priority type
                    let fillColor, textColor, borderColor;

                    switch(priorityType) {
                        case 'High Priority':
                            fillColor = [254, 226, 226]; // Light red
                            textColor = [220, 38, 38];   // Dark red
                            borderColor = [248, 113, 113]; // Border red
                            break;
                        case 'Medium Priority':
                            fillColor = [254, 243, 199]; // Light yellow
                            textColor = [217, 119, 6];   // Dark orange
                            borderColor = [251, 191, 36]; // Border yellow
                            break;
                        case 'Low Priority':
                            fillColor = [220, 252, 231]; // Light green
                            textColor = [22, 163, 74];   // Dark green
                            borderColor = [74, 222, 128]; // Border green
                            break;
                        default: // Not Planned
                            fillColor = [243, 244, 246]; // Light gray
                            textColor = [107, 114, 128]; // Dark gray
                            borderColor = [156, 163, 175]; // Border gray
                    }

                    // Calculate text width to determine badge size
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'bold');
                    const textWidth = pdf.getTextWidth(text);
                    const badgeWidth = Math.max(textWidth + 8, 25); // Minimum width
                    const badgeHeight = 6;
                    const radius = 3;

                    // Draw the rounded rectangle badge
                    pdf.setFillColor(...fillColor);
                    pdf.setDrawColor(...borderColor);
                    pdf.roundedRect(x, y - 4, badgeWidth, badgeHeight, radius, radius, 'FD');

                    // Add the text
                    pdf.setTextColor(...textColor);
                    pdf.text(text, x + 4, y);

                    return badgeWidth;
                };

                // Add logo to the top right of the PDF
                const logo = document.getElementById('pdfLogo');
                if (logo && logo.src) {
                    try {
                        // Add logo to the top right corner
                        const logoWidth = 15;
                        const logoHeight = 22;
                        const logoX = pageWidth - margin - logoWidth;
                        const logoY = margin;

                        // Add the logo image to the PDF
                        pdf.addImage(logo.src, 'PNG', logoX, logoY, logoWidth, logoHeight);

                        // Adjust yPosition to account for logo
                        yPosition += logoHeight + 5;
                    } catch (error) {
                        console.error('Error adding logo to PDF:', error);
                        // Continue without logo if there's an error
                    }
                }

                // Header
                pdf.setFontSize(20);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(30, 64, 175); // Blue color
                pdf.text('User Stories Report', margin, yPosition);
                yPosition += 10;

                // Project info
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(75, 85, 99); // Gray color
                pdf.text(`Project: ${projectName}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`Total Stories: ${totalStories}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, yPosition);
                yPosition += 15;

                // Add a line separator
                pdf.setDrawColor(200, 200, 200);
                pdf.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;

                // Process each user story
                storyCards.forEach((card, index) => {
                    // Extract story data
                    const priorityElement = card.querySelector('span.bg-red-100, span.bg-yellow-100, span.bg-green-100, span.bg-gray-100');
                    const storyId = card.querySelector('span.text-xs.text-gray-500').textContent;
                    const storyText = card.querySelector('p.text-gray-600').textContent;
                    const acceptanceCriteria = Array.from(card.querySelectorAll('ul.list-disc li')).map(li => li.textContent);

                    // Determine priority
                    const priorityText = priorityElement.textContent;

                    // Check if we need a new page before adding this story
                    const estimatedHeight = 50 + (acceptanceCriteria.length * 8);
                    checkPageBreak(estimatedHeight);

                    // Story header with number
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(31, 41, 55); // Dark gray
                    pdf.text(`Story ${index + 1}:`, margin, yPosition);

                    // Draw priority badge
                    const badgeWidth = drawPriorityBadge(margin + 35, yPosition, priorityText, priorityText);

                    // Story ID on the right
                    pdf.setFontSize(10);
                    pdf.setTextColor(107, 114, 128);
                    pdf.text(storyId, pageWidth - margin - 20, yPosition, { align: 'right' });

                    yPosition += 10;

                    // Story text
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(55, 65, 81);
                    const storyHeight = addWrappedText(storyText, margin, yPosition, contentWidth, 6);
                    yPosition += storyHeight + 5;

                    // Acceptance Criteria header
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(30, 64, 175);
                    pdf.text('Acceptance Criteria:', margin, yPosition);
                    yPosition += 6;

                    // Acceptance Criteria items
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(75, 85, 99);

                    acceptanceCriteria.forEach((criteria, critIndex) => {
                        checkPageBreak(10);
                        pdf.text('•', margin, yPosition);
                        const criteriaHeight = addWrappedText(criteria, margin + 5, yPosition, contentWidth - 5, 5);
                        yPosition += Math.max(criteriaHeight, 6);
                    });

                    // Add spacing between stories
                    yPosition += 10;

                    // Add page break if we're near the bottom
                    checkPageBreak(20);
                });

                // Add page numbers
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pdf.internal.pageSize.getHeight() - 10, { align: 'right' });
                }

                // Download the PDF
                const fileName = `User_Stories_${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().getTime()}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }
    </script>
</div>
</body>
</html>