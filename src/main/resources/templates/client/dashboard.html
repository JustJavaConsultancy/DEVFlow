<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Progress - Client Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --accent: #f59e0b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #f8fafc 100%);
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(79, 70, 229, 0.15);
        }

        .progress-transition {
            transition: width 1.5s ease-in-out;
        }

        .priority-high {
            border-left: 4px solid #ef4444;
        }

        .priority-medium {
            border-left: 4px solid #f59e0b;
        }

        .priority-low {
            border-left: 4px solid #10b981;
        }

        .status-completed {
            color: #10b981;
        }

        .status-in-progress {
            color: #3b82f6;
        }

        .status-pending {
            color: #f59e0b;
        }

        .status-blocked {
            color: #ef4444;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .progress-dot.completed {
            background-color: #10b981;
        }

        .progress-dot.current {
            background-color: #3b82f6;
        }

        .progress-dot.upcoming {
            background-color: #d1d5db;
        }

        .document-item {
            transition: all 0.2s ease;
        }

        .document-item:hover {
            background-color: #f3f4f6;
            transform: translateX(5px);
        }

        .activity-item {
            border-left: 3px solid #e5e7eb;
            padding-left: 1rem;
            margin-left: 0.5rem;
        }

        .activity-item:last-child {
            border-left: 3px solid transparent;
        }

        .glow {
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.2);
        }

        .connect-app-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
         .empty-state {
            padding: 3rem 1rem;
            text-align: center;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translate(0, 0px); }
            50% { transform: translate(0, 10px); }
            100% { transform: translate(0, -0px); }
        }

        /* New styles for equal height grid */
        .grid-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .equal-height-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .equal-height-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-scrollable {
            overflow-y: auto;
            max-height: 100%;
        }

        /* Ensure cards take full height of their container */
        .h-full {
            height: 100%;
        }

        /* Custom scrollbar for better appearance */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .completed-tasks-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .completed-tasks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .completed-tasks-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .completed-task-card {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }

        .completion-badge {
            background-color: #10b981;
            color: white;
        }

        /* Hidden content div for PDF generation */
        #documentContent {
            display: none;
        }
        .invite-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: all 0.3s ease;
        }

        .invite-section:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .invite-input {
            background: rgba(249, 250, 251, 0.8);
            border: 1px solid rgba(209, 213, 219, 0.6);
            transition: all 0.3s ease;
            width: 100%;
        }

        .invite-input:focus {
            background: white;
            border-color: rgba(79, 70, 229, 0.4);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .invite-btn {
            background: rgba(79, 70, 229, 0.9);
            color: white;
            transition: all 0.3s ease;
        }

        .invite-btn:hover {
            background: rgba(79, 70, 229, 1);
            transform: translateY(-1px);
        }

        .invite-btn:disabled {
            background: rgba(156, 163, 175, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }
        .input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .input-valid {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .success-message {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
         /* Invite counter styles */
        .invite-counter {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            margin-left: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .invite-counter i {
            margin-right: 0.375rem;
        }

        .invited-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .invited-list.show {
            max-height: 200px;
        }

        .toggle-invited {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

        .toggle-invited:hover {
            color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-800 grid-container">
<!-- Header -->
<header class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-code-branch text-2xl mr-3"></i>
                <h1 class="text-xl font-bold">DevFlow</h1>
            </div>

            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 bg-white bg-opacity-20 rounded-full px-4 py-2">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="currentDate"></span>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full px-4 py-2 glow">
                    <span  th:text="${'Project: ' + project.processVariables['projectName']}">Project: E-Commerce Platform</span>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container mx-auto px-4 py-8 flex-1">
    <!-- Invite Section - Positioned outside the grid -->
    <div class="invite-section rounded-xl p-4 mb-8 card-hover">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0 md:mr-6">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center mr-3">
                    <i class="fas fa-user-plus text-white text-sm"></i>
                </div>

                <div>
                    <h3 class="font-medium text-gray-800 flex items-center">
                        Invite Team Members
                        <span class="invite-counter ml-2" id="inviteCount">
                        <i class="fas fa-users mr-1"></i>
                        <span id="invitedNumber" th:text="|${#lists.size(invitedEmails)} invited|">0</span>
                    </span>
                    </h3>

                    <p class="text-sm text-gray-600">Share this project with other stakeholders</p>

                    <!-- Invited users list -->
                    <div class="invited-list mt-3" id="invitedList"
                         th:if="${invitedEmails != null and !invitedEmails.isEmpty()}">
                        <div class="text-sm font-medium text-gray-700 mb-2">Invited Team Members:</div>
                        <div class="space-y-2">
                            <!-- Loop through invited emails -->
                            <div class="flex items-center text-sm" th:each="email,stat : ${invitedEmails}">
                                <div class="w-6 h-6 rounded-full flex items-center justify-center mr-2" th:classappend="${(stat.index % 5 == 0) ? 'bg-blue-500' : (stat.index % 5 == 1) ? 'bg-green-500' : (stat.index % 5 == 2) ? 'bg-pink-500' : (stat.index % 5 == 3) ? 'bg-purple-500' : 'bg-yellow-500'}">
        <span class="text-white text-xs font-medium"
              th:text="${#strings.substring(email, 0, 2).toUpperCase()}">
            IN
        </span>
                                </div>
                                <span th:text="${email}">example@email.com</span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${invitedEmails == null or invitedEmails.isEmpty()}" class="text-sm text-gray-500 mt-2">
                        No team members invited yet.
                    </div>

                    <button class="toggle-invited mt-2" id="toggleInvited">
                        <i class="fas fa-chevron-down mr-1" id="toggleIcon"></i>
                        <span id="toggleText">Show invited members</span>
                    </button>
                </div>
            </div>

            <!-- Invite Form -->
            <form id="inviteForm" class="flex flex-col sm:flex-row w-full md:w-2/3"
                  th:action="@{/client/project/invite}" method="post">
                <div class="flex-1 mb-2 sm:mb-0 sm:mr-2">
                    <div class="input-wrapper">
                        <input
                                type="email"
                                name="email"
                                id="inviteEmail"
                                placeholder="Enter email address"
                                class="invite-input w-full px-4 py-2 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none"
                                required
                        >
                        <div id="validationIcon" class="validation-icon hidden"></div>
                    </div>

                    <input type="hidden" name="projectId" th:value="${projectId}" />

                    <div id="emailError" class="error-message hidden">
                        Please enter a valid email address
                    </div>
                    <div id="emailSuccess" class="success-message hidden">
                        Invitation sent successfully!
                    </div>
                </div>

                <button id="sendInviteBtn"
                        class="invite-btn font-medium py-2 px-6 rounded-lg flex
                    items-center justify-center whitespace-nowrap"
                        disabled>
                    <i class="fas fa-paper-plane mr-2"></i> Send Invite
                </button>
            </form>
        </div>
    </div>


    <!-- Project Overview -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 glow">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h2 th:text="${project.processVariables['projectName']}" class="text-2xl font-bold text-gray-800 mb-2">E-Commerce Platform</h2>
                <p th:text="${project.processVariables['projectDescription']}" class="text-gray-600">Build a full-featured e-commerce platform with payment integration and inventory management.</p>
            </div>
            <div class="mt-4 md:mt-0">
                    <span th:text="${project.processVariables['clientCompanyName']}" class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-building mr-1"></i> Fashion Retail Co.
                    </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Project Progress -->
            <div class="md:col-span-2 equal-height-container">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span>Project Progress</span>
                    <span th:text="${completedTaskPercentage + '%' + ' Complete'}" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">65% Complete</span>
                </h3>

                <div class="mb-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Overall Progress</span>
                        <span th:text="${completedTaskPercentage + '%'}">65%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full progress-transition" th:style="'width:' + ${completedTaskPercentage} + '%'"></div>
                    </div>
                </div>

                <div class="space-y-4 content-scrollable custom-scrollbar">

                    <!-- 1. Planning Phase -->
                    <div class="flex items-center">
                        <div class="progress-dot"
                             th:classappend="${completedTaskCount >= 2} ? ' completed' :
                             (${completedTaskCount < 2 and completedTaskCount >= 0} ? ' current' : ' upcoming')">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-medium">Planning Phase</span>
                                <span class="text-sm font-medium"
                                      th:classappend="${completedTaskCount >= 2} ? ' text-green-600' :
                                      (${completedTaskCount < 2 and completedTaskCount >= 0} ? ' text-blue-600' : ' text-gray-500')"
                                      th:text="${completedTaskCount >= 2 ? 'Completed' :
                               (completedTaskCount < 2 and completedTaskCount >= 0 ? 'In Progress' : 'Upcoming')}">
                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">Requirements gathering and project planning</div>
                        </div>
                    </div>

                    <!-- 2. Design Phase -->
                    <div class="flex items-center">
                        <div class="progress-dot"
                             th:classappend="${completedTaskCount >= 4} ? ' completed' :
                             (${completedTaskCount < 4 and completedTaskCount >= 3} ? ' current' : ' upcoming')">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-medium">Design Phase</span>
                                <span class="text-sm font-medium"
                                      th:classappend="${completedTaskCount >= 4} ? ' text-green-600' :
                                      (${completedTaskCount < 4 and completedTaskCount >= 3} ? ' text-blue-600' : ' text-gray-500')"
                                      th:text="${completedTaskCount >= 4 ? 'Completed' :
                               (completedTaskCount < 4 and completedTaskCount >= 3 ? 'In Progress' : 'Upcoming')}">
                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">UI/UX design and prototyping</div>
                        </div>
                    </div>

                    <!-- 3. Development Phase -->
                    <div class="flex items-center">
                        <div class="progress-dot"
                             th:classappend="${completedTaskCount >= 6} ? ' completed' :
                             (${completedTaskCount < 6 and completedTaskCount >= 5} ? ' current' : ' upcoming')">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-medium">Development Phase</span>
                                <span class="text-sm font-medium"
                                      th:classappend="${completedTaskCount >= 6} ? ' text-green-600' :
                                      (${completedTaskCount < 6 and completedTaskCount >= 5} ? ' text-blue-600' : ' text-gray-500')"
                                      th:text="${completedTaskCount >= 6 ? 'Completed' :
                               (completedTaskCount < 6 and completedTaskCount >= 5 ? 'In Progress' : 'Upcoming')}">
                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">Backend development and API integration</div>
                        </div>
                    </div>

                    <!-- 4. Testing Phase -->
                    <div class="flex items-center">
                        <div class="progress-dot"
                             th:classappend="${completedTaskCount >= 7} ? ' completed' :
                             (${completedTaskCount == 7} ? ' current' : ' upcoming')">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-medium">Testing Phase</span>
                                <span class="text-sm font-medium"
                                      th:classappend="${completedTaskCount >= 7} ? ' text-green-600' :
                                      (${completedTaskCount == 7} ? ' text-blue-600' : ' text-gray-500')"
                                      th:text="${completedTaskCount >= 7 ? 'Completed' :
                               (completedTaskCount == 7 ? 'In Progress' : 'Upcoming')}">
                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">Quality assurance and user acceptance testing</div>
                        </div>
                    </div>

                    <!-- 5. Launch -->
                    <div class="flex items-center">
                        <div class="progress-dot"
                             th:classappend="${completedTaskCount == 7} ? ' current' : ' upcoming'">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-medium">Launch</span>
                                <span class="text-sm font-medium"
                                      th:classappend="${completedTaskCount == 7} ? ' text-blue-600' : ' text-gray-500'"
                                      th:text="${completedTaskCount == 7 ? 'In Progress' : 'Upcoming'}">
                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">Deployment and go-live</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Project Details -->
            <div class="equal-height-container">
                <h3 class="text-lg font-semibold mb-4">Project Details</h3>

                <div class="space-y-4 content-scrollable custom-scrollbar">
                    <div>
                        <div class="text-sm text-gray-500">Start Date</div>
                        <div th:text="${#dates.format(project.startTime, 'MMM dd, yyyy')}" class="font-medium">June 15, 2023</div>
                    </div>

                    <div>
                        <div class="text-sm text-gray-500">Estimated Completion</div>
                        <div th:text="${project.processVariables['dueDate']}" class="font-medium">November 15, 2023</div>
                    </div>

                    <div>
                        <div class="text-sm text-gray-500">Project Manager</div>
                        <div th:text="${project.processVariables['clientName']}" class="font-medium">John Doe</div>
                    </div>

                    <div>
                        <div class="text-sm text-gray-500">Development Team</div>
                        <div class="font-medium">7 members</div>
                    </div>

                    <div>
                        <div class="text-sm text-gray-500">Last Updated</div>
                        <div class="font-medium">Today</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Live Project URL</div>
                        <div class="mb-2">
                            <div class="text-xs font-mono bg-gray-100 p-2 rounded border break-all">
            <span th:if="${project.processVariables['projectURL']}"
                  th:text="${project.processVariables['projectURL']}">
                https://fashion-retail-ecommerce.devflowplatform.com
            </span>
                                <span th:unless="${project.processVariables['projectURL']}"
                                      class="text-gray-400 italic">
                No project URL set yet
            </span>
                            </div>
                        </div>
                        <a th:if="${project.processVariables['projectURL']}"
                           th:href="${project.processVariables['projectURL']}"
                           target="_blank"
                           class="inline-flex items-center justify-center w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-all duration-300 transform hover:-translate-y-1 shadow-md">
                            <i class="fas fa-external-link-alt mr-2"></i> View Live Project
                        </a>
                        <button th:unless="${project.processVariables['projectURL']}"
                                disabled
                                class="inline-flex items-center justify-center w-full bg-gray-400 text-white py-2 px-4 rounded-lg cursor-not-allowed">
                            <i class="fas fa-external-link-alt mr-2"></i> No Live Project Available
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 equal-height-container">
        <!-- Current Tasks & Activity -->
        <div class="lg:col-span-2 equal-height-content">
            <!-- Connect App Card -->
            <div class="connect-app-card rounded-2xl shadow-lg p-6 mb-8 card-hover h-full">
                <div class="flex flex-col md:flex-row items-center h-full">
                    <div class="flex-shrink-0 mb-4 md:mb-0 md:mr-6">
                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center floating">
                            <i class="fas fa-comments text-2xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h3 class="text-xl font-bold mb-2">Stay Connected with Our App</h3>
                        <p class="mb-4 opacity-90">Use our Connect app for real-time messaging, video calls, and quick updates.</p>
                        <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-4">
                                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                    <i class="fas fa-comment-dots mr-1"></i> Real-time Messaging
                                </span>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                    <i class="fas fa-video mr-1"></i> Video Calls
                                </span>
                            <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                    <i class="fas fa-bolt mr-1"></i> Quick Updates
                                </span>
                        </div>
                        <div class="flex space-x-3">
                            <a href="https://just-community.up.railway.app/oauth2/authorization/keycloak" class="bg-white text-purple-700 hover:bg-gray-100 font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                                Open Connect
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Tasks -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 card-hover h-full">
                <h3 class="text-lg font-semibold mb-4">Current Tasks</h3>

                <div class="space-y-4 content-scrollable custom-scrollbar">
                    <!-- Task 1 -->
                    <div th:each="task : ${tasks}" th:if="${task.state == 'created'}" class="border border-gray-200 rounded-xl p-4 card-hover priority-high">
                        <div class="flex justify-between items-start mb-2">
                            <h4 th:text="${task.name}" class="font-medium">Payment Gateway Integration</h4>
                            <span class="status-in-progress text-sm font-medium">
                                    <i class="fas fa-circle mr-1"></i> In Progress
                                </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">This is the task currently in progress. We are keeping a close eye on every detail to make sure it meets users expectations and contributes to the overall success of the project</p>
                        <div class="flex justify-between items-center text-sm">
                            <div class="flex items-center">

                            </div>
                            <div>
                                <span class="text-gray-500">Started:</span>
                                <span th:text="${#dates.format(task.createTime, 'MMM dd, yyyy')}" class="ml-1 font-medium">Oct 20, 2023</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents & Next Steps -->
        <div class="equal-height-content">
            <!-- Documents -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 card-hover h-full">
                <h3 class="text-lg font-semibold mb-4">Project Documents</h3>
                <div th:if="${project.processVariables?.['aiRequirementAnalysis'] == null}" class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <h4 class="text-xl font-medium text-gray-500 mb-2">No Documents Available</h4>
                    <p class="text-gray-400 mb-4 max-w-md mx-auto">
                        Project documents will appear here once they are uploaded by the development team.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    </div>
                </div>
                <div class="space-y-3 content-scrollable custom-scrollbar">

                    <!-- Project Requirements -->
                    <div th:if="${project.processVariables?.['aiRequirementAnalysis']}"
                         class="document-item flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-file-pdf text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <input type="hidden" id="requirementSpec" th:value="${project.processVariables?.['aiRequirementAnalysis']}">
                            <div class="font-medium">Requirements Specification.pdf</div>
                        </div>
                        <button onclick="downloadRequirementSpec()"
                                class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>

                    <!-- Solution Architecture -->
                    <div th:if="${project.processVariables?.['architecture']}"
                         class="document-item flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer">
                        <div class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-file-pdf text-green-600"></i>
                        </div>
                        <div class="flex-1">
                            <input type="hidden" id="architectureSpec" th:value="${project.processVariables?.['architecture']}">
                            <div class="font-medium">Solution Architecture.pdf</div>
                        </div>
                        <button onclick="downloadArchitectureSpec()"
                                class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <!-- User Stories -->
                    <div th:if="${project.processVariables['stories'] != null
             and project.processVariables['stories']['user_stories'] != null
             and !#lists.isEmpty(project.processVariables['stories']['user_stories'])}"
                         class="document-item flex items-center p-3 border border-gray-200 rounded-lg">
                        <input type="hidden" class="total-stories" th:value="${project.processVariables['stories']['total']}"
                        >
                        <div class="hidden">
                            <div th:each="story, iterStat : ${project.processVariables['stories']['user_stories']}"
                                 class="hidden user-story-card priority-high bg-white border border-gray-200 rounded-lg p-4 md:p-5">

                                <div class="flex justify-between items-start mb-3">
                                    <span th:if="${story.priority == 'Must have'}" class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">High Priority</span>
                                    <span th:if="${story.priority == 'Should have'}" class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Medium Priority</span>
                                    <span th:if="${story.priority == 'Could have'}" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Low Priority</span>
                                    <span th:if="${story.priority == 'Wonâ€™t have'}" class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Not Planned</span>
                                    <span th:text="${story.id}" class="text-xs text-gray-500">US-101</span>
                                </div>

                                <p th:text="${story.story}" class="text-gray-600 text-sm mb-4">
                                    As a new visitor, I want to create an account so that I can make purchases and save my preferences.
                                </p>

                                <div class="mb-4">
                                    <h4 class="font-medium text-sm text-blue-700 mb-1">Acceptance Criteria:</h4>
                                    <ul class="text-xs text-gray-600 list-disc pl-5 space-y-1">
                                        <li th:each="criteria : ${story.acceptance_criteria}" th:text="${criteria}"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- PDF Icon -->
                        <div class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-file-pdf text-purple-600"></i>
                        </div>

                        <!-- Filename + Button on same line -->
                        <div class="flex justify-between items-center flex-1">
                            <div class="font-medium">User Stories.pdf</div>
                            <button onclick="generatePDF()"
                                    class="ml-4 text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>
<!-- Full Width Completed Tasks Section -->
<div th:if="${!#lists.isEmpty(completedTasks)}" class="mt-6">
    <div class="bg-white rounded-2xl shadow-lg p-6 card-hover">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">Completed Tasks</h3>
            <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">
                            <span th:text="${completedTaskCount}" class="font-semibold text-green-600">32</span> tasks completed
                        </span>
            </div>
        </div>

        <div class="completed-tasks-grid">
            <!-- Completed Task 1 -->
            <div th:each="task : ${completedTasks}" class="completed-task-card border border-gray-200 rounded-xl p-4 card-hover">
                <div class="flex justify-between items-start mb-2">
                    <h4 th:text="${task.name}" class="font-medium">User Authentication System</h4>
                    <span class="completion-badge text-xs font-medium px-2 py-1 rounded-full">
                                <i class="fas fa-check mr-1"></i> Completed
                            </span>
                </div>
                <p th:if="${task.name == 'Requirement Elicitation'}" class="text-sm text-gray-600 mb-3">
                    Gathered and documented client requirements to ensure clear understanding of project goals
                </p>
                <p th:if="${task.name == 'Review The SRS'}" class="text-sm text-gray-600 mb-3">
                    Reviewed and validated the Software Requirements Specification to ensure accuracy and completeness
                </p>
                <p th:if="${task.name == 'Review User Stories List'}" class="text-sm text-gray-600 mb-3">
                    Reviewed and refined user stories to ensure clarity, completeness, and alignment with project requirements
                </p>

                <p th:if="${task.name == 'Solution Architecture Review'}" class="text-sm text-gray-600 mb-3">
                    Evaluated the proposed solution architecture for scalability, security, and alignment with business objectives
                </p>

                <p th:if="${task.name == 'Review Generated Layout'}" class="text-sm text-gray-600 mb-3">
                    Assessed the generated UI layouts for usability, consistency, and adherence to design standards
                </p>

                <p th:if="${task.name == 'Review Current User Story Implementation'}" class="text-sm text-gray-600 mb-3">
                    Reviewed implemented user stories to verify functionality and ensure alignment with acceptance criteria
                </p>

                <p th:if="${task.name == 'UAT'}" class="text-sm text-gray-600 mb-3">
                    Conducted User Acceptance Testing to validate the system against business needs and confirm readiness for deployment
                </p>
                <div class="flex justify-between items-center text-sm">
                    <div class="flex items-center">
                        <span class="text-gray-500">Completed by:</span>
                        <span class="ml-2 font-medium">JustJava Team</span>
                    </div>
                    <div>
                        <span th:text="${#dates.format(task.createTime, 'MMM dd, yyyy')}"  class="text-gray-500">Oct 8, 2023</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Hidden logo for PDF generation -->
<img id="pdfLogo" src="/images/JJ LOGOMARK COLORED.png" alt="Company Logo" style="display: none;">

<!-- Footer -->
<footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-code-branch text-xl mr-3"></i>
                <span class="font-medium">DevFlow Client Portal</span>
            </div>

            <div class="text-sm text-gray-400 text-center md:text-right">
                This is a read-only view of your project. For any questions, please contact your project manager.
            </div>
        </div>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Toggle invited members list
            const toggleInvited = document.getElementById('toggleInvited');
            const invitedList = document.getElementById('invitedList');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleText = document.getElementById('toggleText');

            let isListVisible = false;

            toggleInvited.addEventListener('click', function() {
                isListVisible = !isListVisible;

                if (isListVisible) {
                    invitedList.classList.add('show');
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                    toggleText.textContent = 'Hide invited members';
                } else {
                    invitedList.classList.remove('show');
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                    toggleText.textContent = 'Show invited members';
                }
            });
    // Email validation and invite functionality
  const inviteEmailInput = document.getElementById('inviteEmail');
  const sendInviteBtn = document.getElementById('sendInviteBtn');
  const emailError = document.getElementById('emailError');
  const emailSuccess = document.getElementById('emailSuccess');
  const validationIcon = document.getElementById('validationIcon');

  document.getElementById('inviteForm').addEventListener('submit', function(e) {
            sendInviteBtn.disabled = true;
            sendInviteBtn.classList.add('btn-disabled');
            sendInviteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Inviting...';
        });

  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function showError() {
    emailError.classList.remove('hidden');
    emailSuccess.classList.add('hidden');
    inviteEmailInput.classList.add('input-error', 'shake');
    inviteEmailInput.classList.remove('input-valid');
    validationIcon.classList.remove('hidden');
    validationIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
    sendInviteBtn.disabled = true;

    // Remove shake animation after it completes
    setTimeout(() => {
        inviteEmailInput.classList.remove('shake');
    }, 500);
  }

  function showSuccess() {
    emailError.classList.add('hidden');
    emailSuccess.classList.remove('hidden');
    inviteEmailInput.classList.remove('input-error');
    inviteEmailInput.classList.add('input-valid');
    validationIcon.classList.remove('hidden');
    validationIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
    sendInviteBtn.disabled = false;
  }

  function validateInput() {
    const email = inviteEmailInput.value.trim();

    if (email === '') {
        // Empty input
        emailError.classList.add('hidden');
        inviteEmailInput.classList.remove('input-error', 'input-valid');
        validationIcon.classList.add('hidden');
        sendInviteBtn.disabled = true;
        return;
    }

    if (!validateEmail(email)) {
        // Invalid email
        showError();
        return;
    }

    // Valid email
    emailError.classList.add('hidden');
    emailSuccess.classList.add('hidden');
    inviteEmailInput.classList.remove('input-error');
    inviteEmailInput.classList.add('input-valid');
    validationIcon.classList.remove('hidden');
    validationIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
    sendInviteBtn.disabled = false;
  }

  // Validate on input
  inviteEmailInput.addEventListener('input', validateInput);

  // Also validate on Enter key press
  inviteEmailInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendInviteBtn.click();
    }
  });

        // Set current date
        const currentDate = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = currentDate.toLocaleDateString('en-US', options);

        // Animate progress bars
        const progressBars = document.querySelectorAll('.progress-transition');

        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';

            setTimeout(() => {
                bar.style.width = width;
            }, 500);
        });

        // Add hover effects to cards
        const cards = document.querySelectorAll('.card-hover');
        cards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.classList.add('shadow-lg');
            });

            card.addEventListener('mouseleave', () => {
                card.classList.remove('shadow-lg');
            });
        });

    });

    // Enhanced PDF export with logo and improved formatting for requirement and architecture specs
    async function downloadAsPDF(content, filename) {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            unit: 'pt',
            format: 'a4',
            compress: true
        });

        const margin = 40;
        const pageHeight = pdf.internal.pageSize.getHeight();
        const pageWidth = pdf.internal.pageSize.getWidth();
        const contentWidth = pageWidth - (2 * margin);
        let y = margin;

        // Add logo to top right corner
        const logo = document.getElementById('pdfLogo');
        if (logo && logo.src) {
            try {
                const img = new Image();

                img.onload = function() {
                    const logoWidth = 30;
                    const logoHeight = 50;
                    const logoX = pageWidth - margin - logoWidth;
                    const logoY = margin;

                    pdf.addImage(img, 'PNG', logoX, logoY, logoWidth, logoHeight);
                    addDocumentContent();
                };

                img.onerror = function() {
                    console.warn('Logo could not be loaded, proceeding without logo');
                    addDocumentContent();
                };

                img.src = logo.src;

            } catch (error) {
                console.warn('Error loading logo:', error);
                addDocumentContent();
            }
        } else {
            addDocumentContent();
        }

        function addDocumentContent() {
            // Add document header (moved down to accommodate logo)
            y += 40; // Extra space for logo

            // Get project name from the page
            const projectName = document.querySelector('h2.text-2xl')?.textContent || 'Project Document';

            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.setTextColor(30, 64, 175); // Blue color
            pdf.text(filename.replace('.pdf', ''), margin, y);

            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(12);
            pdf.setTextColor(100, 100, 100);
            pdf.text(projectName, margin, y + 20);

            y += 50;

            // Create a temporary div to process the content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;

            // Function to check if we need a page break
            function checkPageBreak(heightNeeded = 0) {
                if (y + heightNeeded > pageHeight - margin) {
                    pdf.addPage();
                    y = margin;
                    // Add logo to new page
                    const logo = document.getElementById('pdfLogo');
                    if (logo && logo.src) {
                        try {
                            const img = new Image();
                            img.onload = function() {
                                const logoWidth = 30;
                                const logoHeight = 50;
                                const logoX = pageWidth - margin - logoWidth;
                                pdf.addImage(img, 'PNG', logoX, margin, logoWidth, logoHeight);
                            };
                            img.src = logo.src;
                        } catch (error) {
                            console.warn('Could not add logo to new page');
                        }
                    }
                    return true;
                }
                return false;
            }

            // Function to add text with proper formatting
            function addText(text, fontSize = 12, isBold = false, indent = 0, lineHeight = 1.4, color = [55, 65, 81]) {
                pdf.setFont("helvetica", isBold ? "bold" : "normal");
                pdf.setFontSize(fontSize);
                pdf.setTextColor(...color);

                const lines = pdf.splitTextToSize(text, contentWidth - indent);
                const lineSpacing = fontSize * lineHeight;

                // Check if we need a page break before adding this text
                checkPageBreak(lines.length * lineSpacing);

                lines.forEach((line, index) => {
                    // Check if we need a page break for each line
                    if (y + lineSpacing > pageHeight - margin) {
                        pdf.addPage();
                        y = margin;
                    }

                    pdf.text(line, margin + indent, y);
                    y += lineSpacing;
                });

                // Add a small gap after the text block
                y += 5;
            }

            // Process tables using jsPDF autotable for proper rendering
            function processTable(table) {
                const data = [];
                const headers = [];

                // Extract headers from thead if exists
                const thead = table.querySelector('thead');
                if (thead) {
                    const headerRow = thead.querySelector('tr');
                    if (headerRow) {
                        Array.from(headerRow.querySelectorAll('th')).forEach(th => {
                            headers.push(th.innerText.trim());
                        });
                        data.push(headers);
                    }
                }

                // Extract data from tbody
                const tbody = table.querySelector('tbody') || table;
                const rows = tbody.querySelectorAll('tr');

                Array.from(rows).forEach(row => {
                    // Skip header row if we already processed thead
                    if (row.parentElement.tagName === 'THEAD') return;

                    const rowData = [];
                    Array.from(row.querySelectorAll('td, th')).forEach(cell => {
                        rowData.push(cell.innerText.trim());
                    });
                    if (rowData.length > 0) {
                        data.push(rowData);
                    }
                });

                if (data.length > 0) {
                    // Calculate table height
                    const estimatedTableHeight = (data.length * 20) + 30;
                    checkPageBreak(estimatedTableHeight);

                    const tableConfig = {
                        startY: y,
                        margin: { left: margin, right: margin },
                        styles: {
                            fontSize: 10,
                            cellPadding: 4,
                            lineColor: [200, 200, 200],
                            lineWidth: 0.5,
                        },
                        headStyles: {
                            fillColor: [243, 244, 246],
                            textColor: [55, 65, 81],
                            fontStyle: 'bold',
                        },
                        alternateRowStyles: {
                            fillColor: [250, 250, 250],
                        },
                        tableWidth: 'auto',
                        columnStyles: {},
                    };

                    // If we have headers from thead, use them as proper headers
                    if (thead && headers.length > 0) {
                        const bodyData = data.slice(1); // Remove header row from data
                        pdf.autoTable({
                            head: [headers],
                            body: bodyData,
                            ...tableConfig
                        });
                    } else {
                        // No explicit headers, treat first row as header
                        pdf.autoTable({
                            head: [data[0]],
                            body: data.slice(1),
                            ...tableConfig
                        });
                    }

                    // Update y position after table
                    const finalY = pdf.lastAutoTable.finalY || y + estimatedTableHeight;
                    y = finalY + 20;
                }
            }

            // Process each node in the content
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    if (node.textContent.trim()) {
                        // Check if parent is bold
                        const parent = node.parentElement;
                        const isBold = parent && (
                                parent.tagName === 'STRONG' ||
                                parent.tagName === 'B' ||
                                parent.style.fontWeight === 'bold'
                        );
                        addText(node.textContent.trim(), 12, isBold);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tag = node.tagName.toLowerCase();
                    const textContent = node.textContent.trim();

                    if (!textContent && tag !== 'table' && tag !== 'div') return;

                    switch(tag) {
                        case "h1":
                            addText(textContent, 18, true, 0, 1.4, [30, 64, 175]);
                            y += 10;
                            break;

                        case "h2":
                            addText(textContent, 16, true, 0, 1.4, [120, 10, 255]);
                            y += 8;
                            break;

                        case "h3":
                            addText(textContent, 14, true, 0, 1.4, [75, 123, 236]);
                            y += 8;
                            break;

                        case "h4":
                            addText(textContent, 13, true, 0, 1.4, [75, 85, 99]);
                            y += 6;
                            break;

                        case "p":
                            addText(textContent, 12, false);
                            break;

                        case "li":
                            const isOrdered = node.parentElement && node.parentElement.tagName === 'OL';
                            const prefix = isOrdered ?
                                    (Array.from(node.parentElement.children).indexOf(node) + 1) + '. ' : 'â€¢ ';
                            addText(prefix + textContent, 12, false, 20);
                            break;

                        case "ul":
                        case "ol":
                            y += 8;
                            Array.from(node.children).forEach(child => processNode(child));
                            y += 8;
                            break;

                        case "strong":
                        case "b":
                            Array.from(node.childNodes).forEach(child => {
                                if (child.nodeType === Node.TEXT_NODE) {
                                    addText(child.textContent.trim(), 12, true);
                                } else {
                                    processNode(child);
                                }
                            });
                            break;

                        case "table":
                            processTable(node);
                            break;

                        case "div":
                            if (node.classList.contains('component-box')) {
                                processComponentBox(node);
                            } else if (node.classList.contains('architecture-diagram')) {
                                processArchitectureDiagram(node);
                            } else if (node.classList.contains('ql-table-embed')) {
                                // Handle table embed div by processing the table inside
                                const table = node.querySelector('table');
                                if (table) processTable(table);
                            } else {
                                Array.from(node.childNodes).forEach(processNode);
                            }
                            break;

                        default:
                            Array.from(node.childNodes).forEach(processNode);
                    }
                }
            }

            // Process component boxes
            function processComponentBox(box) {
                checkPageBreak(40);

                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(11);
                pdf.setTextColor(55, 65, 81);

                const text = pdf.splitTextToSize(box.textContent, contentWidth - 20);
                pdf.text(text, margin + 10, y + 18);

                y += 40;
            }

            // Process architecture diagrams
            function processArchitectureDiagram(diagram) {
                checkPageBreak(100);

                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                pdf.text("Architecture Diagram", pageWidth / 2, y + 45, { align: 'center' });

                y += 100;
            }

            // Process all content nodes
            Array.from(tempDiv.childNodes).forEach(processNode);

            // Add page numbers to footer
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(10);
                pdf.setTextColor(150);
                pdf.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 20, { align: "right" });
            }

            // Save the PDF
            pdf.save(filename);
        }
    }

    // Function to download requirement specification
    function downloadRequirementSpec() {
        const content = document.getElementById('requirementSpec').value;
        downloadAsPDF(content, "requirements-specification.pdf");
    }

    // Function to download architecture specification
    function downloadArchitectureSpec() {
        const content = document.getElementById('architectureSpec').value;
        downloadAsPDF(content, "solution-architecture.pdf");
    }

    // User Stories PDF generation function (unchanged as requested)
    async function generatePDF() {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // Get data from the page
            const storyCards = document.querySelectorAll('.user-story-card');
            const projectName = document.querySelector('h2.text-2xl')?.textContent || 'Project Document';
            const totalStories = document.querySelector('.total-stories').value;

            // PDF settings
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            let yPosition = margin;

            // Function to add text with line breaks
            const addWrappedText = (text, x, y, maxWidth, lineHeight = 7) => {
                const lines = pdf.splitTextToSize(text, maxWidth);
                pdf.text(lines, x, y);
                return lines.length * lineHeight;
            };

            // Function to check if we need a new page
            const checkPageBreak = (requiredHeight) => {
                if (yPosition + requiredHeight > pdf.internal.pageSize.getHeight() - margin) {
                    pdf.addPage();
                    yPosition = margin;
                    return true;
                }
                return false;
            };

            // Function to create a better looking priority badge
            const drawPriorityBadge = (x, y, text, priorityType) => {
                // Define colors based on priority type
                let fillColor, textColor, borderColor;

                switch(priorityType) {
                    case 'High Priority':
                        fillColor = [254, 226, 226]; // Light red
                        textColor = [220, 38, 38];   // Dark red
                        borderColor = [248, 113, 113]; // Border red
                        break;
                    case 'Medium Priority':
                        fillColor = [254, 243, 199]; // Light yellow
                        textColor = [217, 119, 6];   // Dark orange
                        borderColor = [251, 191, 36]; // Border yellow
                        break;
                    case 'Low Priority':
                        fillColor = [220, 252, 231]; // Light green
                        textColor = [22, 163, 74];   // Dark green
                        borderColor = [74, 222, 128]; // Border green
                        break;
                    default: // Not Planned
                        fillColor = [243, 244, 246]; // Light gray
                        textColor = [107, 114, 128]; // Dark gray
                        borderColor = [156, 163, 175]; // Border gray
                }

                // Calculate text width to determine badge size
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                const textWidth = pdf.getTextWidth(text);
                const badgeWidth = Math.max(textWidth + 8, 25); // Minimum width
                const badgeHeight = 6;
                const radius = 3;

                // Draw the rounded rectangle badge
                pdf.setFillColor(...fillColor);
                pdf.setDrawColor(...borderColor);
                pdf.roundedRect(x, y - 4, badgeWidth, badgeHeight, radius, radius, 'FD');

                // Add the text
                pdf.setTextColor(...textColor);
                pdf.text(text, x + 4, y);

                return badgeWidth;
            };

            // Add logo to the top right of the PDF
            const logo = document.getElementById('pdfLogo');
            if (logo && logo.src) {
                try {
                    // Add logo to the top right corner
                    const logoWidth = 15;
                    const logoHeight = 22;
                    const logoX = pageWidth - margin - logoWidth;
                    const logoY = margin;

                    // Add the logo image to the PDF
                    pdf.addImage(logo.src, 'PNG', logoX, logoY, logoWidth, logoHeight);

                    // Adjust yPosition to account for logo
                    yPosition += logoHeight + 5;
                } catch (error) {
                    console.error('Error adding logo to PDF:', error);
                    // Continue without logo if there's an error
                }
            }

            // Header
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(30, 64, 175); // Blue color
            pdf.text('User Stories Report', margin, yPosition);
            yPosition += 10;

            // Project info
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(75, 85, 99); // Gray color
            pdf.text(`Project: ${projectName}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`Total Stories: ${totalStories}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, yPosition);
            yPosition += 15;

            // Add a line separator
            pdf.setDrawColor(200, 200, 200);
            pdf.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;

            // Process each user story
            storyCards.forEach((card, index) => {
                // Extract story data
                const priorityElement = card.querySelector('span.bg-red-100, span.bg-yellow-100, span.bg-green-100, span.bg-gray-100');
                const storyId = card.querySelector('span.text-xs.text-gray-500').textContent;
                const storyText = card.querySelector('p.text-gray-600').textContent;
                const acceptanceCriteria = Array.from(card.querySelectorAll('ul.list-disc li')).map(li => li.textContent);

                // Determine priority
                const priorityText = priorityElement.textContent;

                // Check if we need a new page before adding this story
                const estimatedHeight = 50 + (acceptanceCriteria.length * 8);
                checkPageBreak(estimatedHeight);

                // Story header with number
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(31, 41, 55); // Dark gray
                pdf.text(`Story ${index + 1}:`, margin, yPosition);

                // Draw priority badge
                const badgeWidth = drawPriorityBadge(margin + 35, yPosition, priorityText, priorityText);

                // Story ID on the right
                pdf.setFontSize(10);
                pdf.setTextColor(107, 114, 128);
                pdf.text(storyId, pageWidth - margin - 20, yPosition, { align: 'right' });

                yPosition += 10;

                // Story text
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(55, 65, 81);
                const storyHeight = addWrappedText(storyText, margin, yPosition, contentWidth, 6);
                yPosition += storyHeight + 5;

                // Acceptance Criteria header
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(30, 64, 175);
                pdf.text('Acceptance Criteria:', margin, yPosition);
                yPosition += 6;

                // Acceptance Criteria items
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(75, 85, 99);

                acceptanceCriteria.forEach((criteria, critIndex) => {
                    checkPageBreak(10);
                    pdf.text('â€¢', margin, yPosition);
                    const criteriaHeight = addWrappedText(criteria, margin + 5, yPosition, contentWidth - 5, 5);
                    yPosition += Math.max(criteriaHeight, 6);
                });

                // Add spacing between stories
                yPosition += 10;

                // Add page break if we're near the bottom
                checkPageBreak(20);
            });

            // Add page numbers
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(150, 150, 150);
                pdf.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pdf.internal.pageSize.getHeight() - 10, { align: 'right' });
            }

            // Download the PDF
            const fileName = `User_Stories_${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().getTime()}.pdf`;
            pdf.save(fileName);

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
        }
    }
</script>
</body>
</html>