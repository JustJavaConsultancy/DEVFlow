<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantUML Diagram Generator</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        .diagram-container {
            min-height: 400px;
            border: 2px dashed #dee2e6;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }
        .diagram-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .plantuml-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .cursor-wait {
            cursor: wait;
        }
        .temp-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-upload-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .health-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .health-healthy {
            background-color: #28a745;
        }
        .health-unhealthy {
            background-color: #dc3545;
        }
        .health-checking {
            background-color: #ffc107;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <!-- Service Health Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-center mb-0">üåø PlantUML Diagram Generator</h1>
                <div class="d-flex align-items-center">
                    <span class="health-indicator health-checking" id="health-indicator"></span>
                    <small class="text-muted" id="health-status">Checking service health...</small>
                    <button class="btn btn-sm btn-outline-info ms-2"
                            onclick="checkServiceHealth()"
                            title="Check service health">
                        üîÑ
                    </button>
                </div>
            </div>
            <p class="text-center text-muted mb-0">
                Create UML diagrams using PlantUML syntax. Powered by Spring Boot + HTMX
            </p>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Editor -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üìù PlantUML Editor</span>
                    <div class="d-flex gap-2">
                        <!-- File Upload -->
                        <div class="file-upload-wrapper">
                            <button class="btn btn-outline-primary btn-sm">
                                üìÅ Upload File
                            </button>
                            <input type="file"
                                   name="plantUmlFile"
                                   accept=".puml,.txt,.plantuml"
                                   hx-post="/diagrams/upload-plantuml-file"
                                   hx-target="#upload-result"
                                   hx-encoding="multipart/form-data"
                                   hx-on:change="this.form.requestSubmit()">
                        </div>

                        <!-- Syntax Validation -->
                        <button class="btn btn-outline-info btn-sm"
                                hx-post="/diagrams/validate-syntax-htmx"
                                hx-target="#validation-result"
                                hx-include="#plantUmlSource"
                                hx-indicator="#validation-indicator">
                            Validate Syntax
                        </button>

                        <!-- Auto-Correct -->
                        <button class="btn btn-outline-warning btn-sm"
                                hx-post="/diagrams/auto-correct-htmx"
                                hx-target="#plantUmlSource"
                                hx-include="#plantUmlSource"
                                hx-indicator="#auto-correct-indicator"
                                title="Auto-correct common syntax issues">
                            üîÑ Auto-Correct
                        </button>

                        <!-- Clear Editor -->
                        <button class="btn btn-outline-secondary btn-sm"
                                onclick="document.getElementById('plantUmlSource').value = ''">
                            Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="diagramForm">
                        <div class="mb-3">
                                <textarea id="plantUmlSource"
                                          name="plantUmlSource"
                                          class="form-control plantuml-editor"
                                          rows="15"
                                          placeholder="@startuml&#10;Alice -> Bob: Hello&#10;Bob --> Alice: Hi!&#10;@enduml"
                                          th:text="${defaultPlantUml}"></textarea>
                        </div>

                        <!-- Upload Result -->
                        <div id="upload-result" class="mb-2"></div>

                        <!-- Validation Result -->
                        <div id="validation-result" class="mb-3"></div>

                        <!-- Validation Indicator -->
                        <div id="validation-indicator" class="htmx-indicator mb-2">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Validating...</span>
                            </div>
                            <small class="text-muted ms-2">Validating syntax...</small>
                        </div>

                        <!-- Auto-Correct Indicator -->
                        <div id="auto-correct-indicator" class="htmx-indicator mb-2">
                            <div class="spinner-border spinner-border-sm text-warning" role="status">
                                <span class="visually-hidden">Auto-correcting...</span>
                            </div>
                            <small class="text-muted ms-2">Auto-correcting syntax...</small>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <!-- Generate Diagram -->
                            <button type="button"
                                    class="btn btn-primary"
                                    hx-post="/diagrams/generate-diagram-htmx"
                                    hx-target="#diagram-result"
                                    hx-include="#plantUmlSource"
                                    hx-indicator="#generate-indicator"
                                    hx-on:htmx:before-request="document.body.classList.add('cursor-wait')"
                                    hx-on:htmx:after-request="document.body.classList.remove('cursor-wait')">
                                üé® Generate Diagram
                            </button>

                            <!-- Direct Download -->
                            <button type="button"
                                    class="btn btn-success"
                                    hx-post="/diagrams/download-diagram-htmx"
                                    hx-include="#plantUmlSource"
                                    hx-indicator="#download-indicator"
                                    hx-on:click="setDownloadFilename()">
                                üíæ Download PNG
                            </button>

                            <!-- Preview Download -->
                            <button type="button"
                                    class="btn btn-outline-success"
                                    hx-post="/diagrams/download-diagram-info"
                                    hx-target="#download-result"
                                    hx-include="#plantUmlSource"
                                    hx-indicator="#download-indicator">
                                üì• Prepare Download
                            </button>
                        </div>
                    </form>

                    <!-- Generate Indicator -->
                    <div id="generate-indicator" class="htmx-indicator mt-2">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating diagram...</span>
                        </div>
                        <span class="text-muted ms-2">Generating diagram (with auto-correction fallback)...</span>
                    </div>

                    <!-- Download Indicator -->
                    <div id="download-indicator" class="htmx-indicator mt-2">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Preparing download...</span>
                        </div>
                        <span class="text-muted ms-2">Preparing download...</span>
                    </div>

                    <!-- Download Result -->
                    <div id="download-result" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Right Column: Diagram Output -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üñºÔ∏è Generated Diagram</span>
                    <div>
                        <small class="text-muted" id="diagram-info"></small>
                        <button class="btn btn-sm btn-outline-secondary ms-2"
                                onclick="clearDiagram()"
                                title="Clear diagram">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="diagram-result" class="diagram-container">
                        <div class="text-center text-muted">
                            <div>Your diagram will appear here</div>
                            <small>Write PlantUML code and click "Generate Diagram"</small>
                            <div class="mt-2">
                                <small class="text-info">üí° Auto-correction will be applied if needed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tools & Status Section -->
    <div class="row mt-4">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    üöÄ Quick Examples
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100 btn-sm"
                                    onclick="loadExample('sequence')">
                                Sequence Diagram
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100 btn-sm"
                                    onclick="loadExample('class')">
                                Class Diagram
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100 btn-sm"
                                    onclick="loadExample('activity')">
                                Activity Diagram
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100 btn-sm"
                                    onclick="loadExample('component')">
                                Component Diagram
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100 btn-sm"
                                    onclick="loadExample('usecase')">
                                Use Case Diagram
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100 btn-sm"
                                    onclick="loadExample('state')">
                                State Diagram
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    üîß Service Tools
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-info btn-sm"
                                hx-get="/diagrams/service-health"
                                hx-target="#health-result">
                            Check Service Health
                        </button>
                        <button class="btn btn-outline-warning btn-sm"
                                onclick="testAutoCorrection()">
                            Test Auto-Correction
                        </button>
                        <button class="btn btn-outline-secondary btn-sm"
                                onclick="loadProblematicExample()">
                            Load Problematic Example
                        </button>
                    </div>
                    <div id="health-result" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript (minimal, only for functionality not available in HTMX) -->
<script>
    // Load example PlantUML code
    function loadExample(type) {
        const examples = {
            sequence: `@startuml
actor User
participant "Web Server" as Server
participant "Database" as DB

User -> Server: Login Request
Server -> DB: Validate Credentials
DB --> Server: User Data
Server --> User: Login Success

User -> Server: Fetch Profile
Server -> DB: Get Profile
DB --> Server: Profile Data
Server --> User: Profile Info
@enduml`,

            class: `@startuml
class Car {
  - make: String
  - model: String
  - year: int
  ..
  + start(): boolean
  + stop(): void
  + getInfo(): String
}

class Engine {
  - horsepower: int
  - fuelType: String
  ..
  + start(): boolean
}

Car *-- Engine
@enduml`,

            activity: `@startuml
start
:User visits site;
if (User logged in?) then (yes)
  :Show dashboard;
else (no)
  :Show login page;
  :User enters credentials;
  if (Valid credentials?) then (yes)
    :Create session;
    :Redirect to dashboard;
  else (no)
    :Show error message;
    :Return to login;
  endif
endif
stop
@enduml`,

            component: `@startuml
component "API Gateway" as Gateway
component "User Service" as User
component "Product Service" as Product
component "Database" as DB

Gateway --> User
Gateway --> Product
User --> DB
Product --> DB
@enduml`,

            usecase: `@startuml
actor User
actor Admin

(Login) as login
(View Products) as view
(Manage Users) as manage

User --> login
User --> view
Admin --> login
Admin --> manage
@enduml`,

            state: `@startuml
[*] --> Idle
Idle --> Processing : start
Processing --> Idle : complete
Processing --> Error : failure
Error --> Idle : reset
@enduml`
        };

        if (examples[type]) {
            document.getElementById('plantUmlSource').value = examples[type];
            autoResizeTextarea();
            showTempMessage('Example loaded successfully!', 'success');
            // Trigger validation
            htmx.trigger('#plantUmlSource', 'change');
        }
    }

    // Load problematic example to test auto-correction
    function loadProblematicExample() {
        const problematicExample = `@startuml
[API Gateway/WAF] --> [Identity & Access]
[API Gateway/WAF] --> [Tenant & Catalogue]
[API Gateway/WAF] --> [Request & Workflow]
[All Services] ..> [Audit & Compliance] : emit events
@enduml`;

        document.getElementById('plantUmlSource').value = problematicExample;
        autoResizeTextarea();
        showTempMessage('Problematic example loaded. Try generating to see auto-correction in action!', 'warning');
    }

    // Test auto-correction functionality
    function testAutoCorrection() {
        const testCode = document.getElementById('plantUmlSource').value;
        if (!testCode.trim()) {
            loadProblematicExample();
        }

        htmx.ajax('POST', '/diagrams/auto-correct-htmx', {
            values: { plantUmlSource: document.getElementById('plantUmlSource').value },
            target: '#plantUmlSource',
            swap: 'none'
        });
    }

    // Apply auto-corrected code to editor
    function applyAutoCorrectedCode(correctedCode) {
        document.getElementById('plantUmlSource').value = correctedCode;
        htmx.trigger('#plantUmlSource', 'change');
        showTempMessage('Auto-corrected code applied to editor!', 'success');
    }

    // Clear diagram display
    function clearDiagram() {
        document.getElementById('diagram-result').innerHTML =
            '<div class="text-center text-muted">' +
            '<div>Your diagram will appear here</div>' +
            '<small>Write PlantUML code and click "Generate Diagram"</small>' +
            '</div>';
        document.getElementById('diagram-info').textContent = '';
        showTempMessage('Diagram cleared', 'info');
    }

    // Service health check
    function checkServiceHealth() {
        const indicator = document.getElementById('health-indicator');
        const status = document.getElementById('health-status');

        indicator.className = 'health-indicator health-checking';
        status.textContent = 'Checking service health...';

        htmx.ajax('GET', '/diagrams/service-health', {
            target: '#health-result',
            swap: 'innerHTML',
            handler: function(xhr) {
                if (xhr.status === 200) {
                    if (xhr.responseText.includes('alert-success')) {
                        indicator.className = 'health-indicator health-healthy';
                        status.textContent = 'Service healthy';
                        showTempMessage('Service is running properly!', 'success');
                    } else {
                        indicator.className = 'health-indicator health-unhealthy';
                        status.textContent = 'Service issues detected';
                        showTempMessage('Service may have issues', 'warning');
                    }
                }
            }
        });
    }

    // Set download filename before HTMX request
    function setDownloadFilename() {
        let filenameInput = document.getElementById('download-filename');
        if (!filenameInput) {
            filenameInput = document.createElement('input');
            filenameInput.type = 'hidden';
            filenameInput.name = 'filename';
            filenameInput.id = 'download-filename';
            document.getElementById('diagramForm').appendChild(filenameInput);
        }
        filenameInput.value = 'diagram-' + new Date().toISOString().slice(0, 10) + '.png';
    }

    // Function to trigger download from base64 data
    function triggerDownload(base64Data) {
        try {
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: 'image/png' });

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'diagram-' + new Date().toISOString().slice(0, 10) + '.png';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showTempMessage('Download started successfully!', 'success');
        } catch (error) {
            showTempMessage('Download failed: ' + error.message, 'danger');
        }
    }

    // Show temporary message
    function showTempMessage(message, type) {
        const existingAlerts = document.querySelectorAll('.temp-alert');
        existingAlerts.forEach(alert => alert.remove());

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show temp-alert`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(alert);

        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    // Auto-resize textarea
    function autoResizeTextarea() {
        const textarea = document.getElementById('plantUmlSource');
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.getElementById('plantUmlSource');
        textarea.addEventListener('input', autoResizeTextarea);

        // Set initial height
        setTimeout(autoResizeTextarea, 100);

        // Auto-validate on content change (with debounce)
        let validateTimeout;
        textarea.addEventListener('input', function() {
            clearTimeout(validateTimeout);
            validateTimeout = setTimeout(() => {
                htmx.trigger('#plantUmlSource', 'change');
            }, 1000);
        });

        // Update diagram info when generation succeeds
        document.body.addEventListener('htmx:afterOnLoad', function(evt) {
            if (evt.detail.target.id === 'diagram-result' && evt.detail.xhr.status === 200) {
                const response = evt.detail.xhr.responseText;
                if (response.includes('alert-warning')) {
                    document.getElementById('diagram-info').textContent = '‚ö† Diagram generated with auto-correction';
                } else {
                    document.getElementById('diagram-info').textContent = '‚úì Diagram generated successfully';
                }
                setTimeout(() => {
                    document.getElementById('diagram-info').textContent = '';
                }, 5000);
            }

            // Handle auto-correction responses
            if (evt.detail.target.id === 'plantUmlSource' && evt.detail.xhr.status === 200) {
                showTempMessage('Auto-correction applied successfully!', 'success');
            }
        });

        // Handle HTMX errors
        document.body.addEventListener('htmx:responseError', function(evt) {
            console.error('HTMX Error:', evt.detail);
            showTempMessage('Request failed: ' + (evt.detail.xhr.statusText || 'Unknown error'), 'danger');
        });

        // Enhance file upload to show filename
        document.addEventListener('change', function(evt) {
            if (evt.target.name === 'plantUmlFile' && evt.target.files.length > 0) {
                const fileName = evt.target.files[0].name;
                const uploadBtn = evt.target.previousElementSibling;
                if (uploadBtn) {
                    uploadBtn.textContent = 'üìÅ ' + fileName;
                }
            }
        });

        // Initial health check
        setTimeout(checkServiceHealth, 1000);
    });
</script>
</body>
</html>