name: devflow-ci-cd

on:
  push:
    branches:
      - master
      - prod # prod deployments happen only on prod

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build & run tests
        run: mvn clean verify -DskipTests

      # - name: SonarCloud Analysis
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: |
      #     mvn sonar:sonar \
      #       -Dsonar.projectKey=JustJavaConsultancyCommunity \
      #       -Dsonar.organization=justjavaconsultancyng \
      #       -Dsonar.host.url=https://sonarcloud.io \
      #       -Dsonar.login=$SONAR_TOKEN

      - name: Build & push Docker image
        run: |
          IMAGE_REF="kazeemakinrinde/devflow:${{ github.sha }}"
          echo "IMAGE_REF=$IMAGE_REF" >> $GITHUB_ENV
          mvn compile jib:build -Dimage=$IMAGE_REF

  deploy-dev:
    name: Deploy Dev
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/dev'
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Deploy dev to railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 7edc707c-73e3-4b8b-915b-019e9d0b6114
          RAILWAY_SERVICE_ID: Devflow
        run: |
          echo "Deploying Dev with image: $IMAGE_REF"
          railway variables --set "RAILWAY_SERVICE_IMAGE=$IMAGE_REF" --service $RAILWAY_SERVICE_ID

  deploy-prod:
    name: Deploy Prod
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/prod'
    environment:
      name: production # requires manual approval in GitHub settings
      url: https://devflow-2-production.up.railway.app
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Deploy to Prod
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 7edc707c-73e3-4b8b-915b-019e9d0b6114
          RAILWAY_SERVICE_ID: Devflow-2
        run: |
          echo "Deploying Prod with image: $IMAGE_REF"
          railway variables --set "RAILWAY_SERVICE_IMAGE=$IMAGE_REF" --service $RAILWAY_SERVICE_ID

















