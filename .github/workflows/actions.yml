name: devflow-ci-cd

on:
  push:
    branches:
      - master
      - qa
      - prod # prod deployments happen only on prod

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build & run tests
        run: mvn clean verify -DskipTests

      # - name: SonarCloud Analysis
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: |
      #     mvn sonar:sonar \
      #       -Dsonar.projectKey=JustJavaConsultancyCommunity \
      #       -Dsonar.organization=justjavaconsultancyng \
      #       -Dsonar.host.url=https://sonarcloud.io \
      #       -Dsonar.login=$SONAR_TOKEN

      - name: Install glibc
        run: sudo apt-get update && sudo apt-get install -y libc6

      - name: Build jar
        id: jib-build
        run: mvn clean compile jib:build

      - name: Push Docker image
        run: |
          IMAGE_REF="kazeemakinrinde/devflow:${{ github.sha }}"
          echo "IMAGE_REF=$IMAGE_REF" >> $GITHUB_ENV
          echo "Updating service image to: $IMAGE_REF"

  deploy-QA:
    name: Deploy QA
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/qa'
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Deploy dev to railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 7edc707c-73e3-4b8b-915b-019e9d0b6114
          RAILWAY_SERVICE_ID: Devflow-QA
        run: |
          echo "Deploying Dev with image: $IMAGE_REF"
          railway variables --set "RAILWAY_SERVICE_IMAGE=$IMAGE_REF" --service $RAILWAY_SERVICE_ID

  deploy-master:
    name: Deploy master
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Deploy dev to railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 7edc707c-73e3-4b8b-915b-019e9d0b6114
          RAILWAY_SERVICE_ID: Devflow-Prod
        run: |
          echo "Deploying Dev with image: $IMAGE_REF"
          railway variables --set "RAILWAY_SERVICE_IMAGE=$IMAGE_REF" --service $RAILWAY_SERVICE_ID

  deploy-prod:
    name: Deploy Prod
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/prod'
    environment:
      name: production # requires manual approval in GitHub settings
      url: https://devflow-prod-production.up.railway.app
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Deploy to Prod
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 7edc707c-73e3-4b8b-915b-019e9d0b6114
          RAILWAY_SERVICE_ID: Devflow-2
        run: |
          echo "Deploying Prod with image: $IMAGE_REF"
          railway variables --set "RAILWAY_SERVICE_IMAGE=$IMAGE_REF" --service $RAILWAY_SERVICE_ID
